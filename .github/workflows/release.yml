name: Publish Fifth Compiler and SDK to NuGet

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
      - 'v[0-9]+.[0-9]+.[0-9]+-*'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (skip publishing to NuGet)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  publish:
    name: Pack and publish to NuGet
    runs-on: ubuntu-latest
    environment: release
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET SDK (global.json)
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Determine release version
        id: version
        shell: bash
        run: |
          set -euo pipefail
          # Use --allow-dirty since GitHub runner provides clean checkout
          # but git may detect false modifications due to line ending handling
          VERSION=$(./scripts/release/version-info.sh --format text --allow-dirty)
          echo "Publishing version $VERSION"
          echo "value=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Determine dry run mode
        id: dryrun
        shell: bash
        run: |
          set -euo pipefail
          if [[ '${{ github.event_name }}' == 'workflow_dispatch' && '${{ inputs.dry_run }}' == 'true' ]]; then
              echo "Workflow dispatch requested dry run"
              echo "value=true" >> "$GITHUB_OUTPUT"
          else
              echo "value=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Restore NuGet packages
        shell: bash
        run: |
          set -euo pipefail
          dotnet restore fifthlang.sln

      - name: Build solution
        shell: bash
        run: |
          set -euo pipefail
          dotnet build fifthlang.sln -c Release --no-restore

      - name: Run tests
        shell: bash
        run: |
          set -euo pipefail
          dotnet test fifthlang.sln -c Release --no-build --no-restore --verbosity=minimal

      - name: Verify NuGet publish secret
        if: steps.dryrun.outputs.value != 'true'
        shell: bash
        env:
          NUGET_PUBLISH: ${{ secrets.NUGET_PUBLISH }}
        run: |
          set -euo pipefail
          if [[ -z "$NUGET_PUBLISH" ]]; then
              echo "::error::NUGET_PUBLISH secret is not set."
              exit 1
          fi

      - name: Pack SDK and compiler tool
        shell: bash
        run: |
          set -euo pipefail
          VERSION='${{ steps.version.outputs.value }}'
          dotnet pack src/Fifth.Sdk/Fifth.Sdk.csproj -c Release /p:Version="$VERSION"
          dotnet pack src/compiler/compiler.csproj -c Release /p:Version="$VERSION"

      - name: Publish SDK and compiler tool to NuGet
        if: steps.dryrun.outputs.value != 'true'
        shell: bash
        env:
          NUGET_PUBLISH: ${{ secrets.NUGET_PUBLISH }}
          NUGET_SOURCE: https://api.nuget.org/v3/index.json
        run: |
          set -euo pipefail
          VERSION='${{ steps.version.outputs.value }}'
          dotnet nuget push "src/Fifth.Sdk/bin/Release/Fifth.Sdk.$VERSION.nupkg" --api-key "$NUGET_PUBLISH" --source "$NUGET_SOURCE" --skip-duplicate
          dotnet nuget push "src/compiler/bin/Release/Fifth.Compiler.Tool.$VERSION.nupkg" --api-key "$NUGET_PUBLISH" --source "$NUGET_SOURCE" --skip-duplicate

      - name: Detect release channel
        id: channel
        shell: bash
        run: |
          set -euo pipefail
          VERSION='${{ steps.version.outputs.value }}'
          if [[ "$VERSION" == *-* ]]; then
              echo "is_prerelease=true" >> "$GITHUB_OUTPUT"
          else
              echo "is_prerelease=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Generate release notes
        id: release_notes
        shell: bash
        run: |
          set -euo pipefail
          NOTES_FILE="${{ runner.temp }}/RELEASE_NOTES.md"
          VERSION='${{ steps.version.outputs.value }}'
          echo "## Fifth Compiler ${VERSION}" > "$NOTES_FILE"
          echo "" >> "$NOTES_FILE"
          echo "Published to NuGet:" >> "$NOTES_FILE"
          echo "- **Fifth.Sdk** (MSBuild SDK for Fifth language projects)" >> "$NOTES_FILE"
          echo "- **Fifth.Compiler.Tool** (Global dotnet tool)" >> "$NOTES_FILE"
          echo "" >> "$NOTES_FILE"
          echo "Install the tool:" >> "$NOTES_FILE"
          echo "\`\`\`bash" >> "$NOTES_FILE"
          echo "dotnet tool install -g Fifth.Compiler.Tool" >> "$NOTES_FILE"
          echo "\`\`\`" >> "$NOTES_FILE"
          echo "" >> "$NOTES_FILE"
          echo "- Commit: ${GITHUB_SHA}" >> "$NOTES_FILE"
          echo "- Generated: $(date -u '+%Y-%m-%d %H:%M:%SZ')" >> "$NOTES_FILE"
          echo "" >> "$NOTES_FILE"

          echo "notes<<EOF" >> "$GITHUB_OUTPUT"
          cat "$NOTES_FILE" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v1
        if: steps.dryrun.outputs.value != 'true'
        with:
          tag_name: ${{ github.ref_name }}
          name: Fifth Compiler ${{ steps.version.outputs.value }}
          body: ${{ steps.release_notes.outputs.notes }}
          draft: false
          prerelease: ${{ steps.channel.outputs.is_prerelease == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Dry run summary
        if: steps.dryrun.outputs.value == 'true'
        shell: bash
        run: |
          set -euo pipefail
          VERSION='${{ steps.version.outputs.value }}'
          echo "## DRY RUN: Would publish Fifth Compiler $VERSION"
          echo ""
          echo "Packages to publish:"
          ls -lh src/Fifth.Sdk/bin/Release/Fifth.Sdk.$VERSION.nupkg
          ls -lh src/compiler/bin/Release/Fifth.Compiler.Tool.$VERSION.nupkg
