<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://fifth-lang.org/Designs/misc/destructuring-lowering-migration/" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>Destructuring Lowering Migration to Statement-Hoisting Rewriter - The Fifth Programming Language</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Destructuring Lowering Migration to Statement-Hoisting Rewriter";
        var mkdocs_page_input_path = "Designs\\misc\\destructuring-lowering-migration.md";
        var mkdocs_page_url = "/Designs/misc/destructuring-lowering-migration/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> The Fifth Programming Language
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">Fifth Language</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Blog</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../Blog/2025-09-16-graph-assertion-block/">Announcing Graph Assertion Blocks in Fifth</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../Blog/2025-11-16%20Announcing%20Fifth%20Lang/">Announcing Fifth - A New Language For Knowledge Graphs</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../Blog/2025-11-28-release-packaging-pipeline/">A New Release Pipeline for Fifth</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Designs</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../../5thproj-implementation-summary/">.5thproj MSBuild Project Type Implementation Summary</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../fifth-sdk-readme/">Fifth.Sdk</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" >Misc</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../AST_REWRITER_DESIGN/">AST Rewriter Design</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../debugging/">Debugging Workflows</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="#">Destructuring Lowering Migration to Statement-Hoisting Rewriter</a>
    <ul class="current">
    <li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#background">Background</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#previous-implementation">Previous Implementation</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#new-implementation">New Implementation</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#architecture">Architecture</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#compilation-pipeline">Compilation Pipeline</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#destructuringloweringrewriter">DestructuringLoweringRewriter</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#key-benefits">Key Benefits</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#1-statement-hoisting">1. Statement Hoisting</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#2-no-backend-special-cases">2. No Backend Special Cases</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#3-clean-separation-of-concerns">3. Clean Separation of Concerns</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#implementation-details">Implementation Details</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#property-type-resolution">Property Type Resolution</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#constraint-rewriting">Constraint Rewriting</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#fresh-name-generation">Fresh Name Generation</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#testing">Testing</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#ast-tests">AST Tests</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#runtime-integration-tests">Runtime Integration Tests</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#migration-guide">Migration Guide</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#future-work">Future Work</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#references">References</a>
    </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../generics-implementation-summary/">Generic Type Support Implementation Summary</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../migration-exception-handling/">Migration Notes - Exception Handling Support</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../namespace-import-directives-research/">Research Notes: Namespace Import Directives</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../syntax-samples-readme/">Syntax Samples</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../syntax-testcases-bulleted/">Fifth Syntax Unit Tests (Bulleted)</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../syntax-testplan/">Fifth Language Syntax Test Plan</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../triple-diagnostics-refactor/">Deferred Triple Diagnostics Refactor</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../vscode-devkit-tests/">VS Code Dev Kit: Running xUnit Tests</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Perf</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../perf/baselines/">Baselines</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Development</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../Development/release-process/">Fifth Language Release Process</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Getting Started</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../Getting-Started/installation/">Installation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../Getting-Started/knowledge-graphs/">Knowledge Graphs in Fifth</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../Getting-Started/learn5thInYMinutes/">learn5thInYMinutes</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Planning</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" >Architecture review</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../Planning/architecture-review/NEXT-STEPS/">Architectural Review - Next Steps</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../Planning/architecture-review/architectural-review-2025/">Fifth Language Compiler - Architectural Review Report</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Arch review issues</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../../Planning/architecture-review/arch-review-issues/">Architectural Review Issues</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../Planning/architecture-review/arch-review-issues/ISSUE-001-error-recovery/">Parser Needs Error Recovery for IDE Support</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../Planning/architecture-review/arch-review-issues/ISSUE-002-lsp-implementation/">Implement Language Server Protocol (LSP) for IDE Integration</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../Planning/architecture-review/arch-review-issues/ISSUE-003-incremental-compilation/">Implement Incremental Compilation for Performance and IDE Support</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../Planning/architecture-review/arch-review-issues/ISSUE-004-diagnostic-system/">Redesign Diagnostic System for Quality Error Messages and IDE Support</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../Planning/architecture-review/arch-review-issues/ISSUE-005-composable-pipeline/">Refactor Transformation Pipeline to Composable Architecture</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../Planning/architecture-review/arch-review-issues/ISSUE-006-symbol-table/">Enhance Symbol Table for Performance and IDE Features</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../Planning/architecture-review/arch-review-issues/ISSUE-007-testing-architecture/">Restructure Testing Architecture for Better Coverage and Maintainability</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">The Fifth Programming Language</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Designs</li>
          <li class="breadcrumb-item">Misc</li>
      <li class="breadcrumb-item active">Destructuring Lowering Migration to Statement-Hoisting Rewriter</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="destructuring-lowering-migration-to-statement-hoisting-rewriter">Destructuring Lowering Migration to Statement-Hoisting Rewriter</h1>
<h2 id="overview">Overview</h2>
<p>This document describes the migration of destructuring lowering from a bespoke recursive-descent visitor pattern to the statement-hoisting rewriter pattern using <code>DefaultAstRewriter</code>.</p>
<h2 id="background">Background</h2>
<h3 id="previous-implementation">Previous Implementation</h3>
<p>The old destructuring implementation consisted of three interconnected visitors:</p>
<ol>
<li><strong>DestructuringVisitor</strong> - Resolved property references in destructuring patterns</li>
<li><strong>DestructuringPatternFlattenerVisitor</strong> - Collected constraints and synthesized variable declarations</li>
<li><strong>PropertyBindingToVariableDeclarationTransformer</strong> - Actually created the VarDeclStatements</li>
</ol>
<p>This approach had several issues:
- Complex interdependencies between visitors
- Difficult to reason about execution order
- Mixed concerns (resolution, constraint handling, lowering)
- Backend needed awareness of destructuring forms</p>
<h3 id="new-implementation">New Implementation</h3>
<p>The new implementation uses a clean two-phase approach:</p>
<ol>
<li><strong>DestructuringVisitor</strong> (unchanged) - Resolves property references</li>
<li><strong>DestructuringLoweringRewriter</strong> (new) - Handles all lowering:</li>
<li>Constraint collection and rewriting</li>
<li>Variable declaration generation</li>
<li>Statement hoisting to function body start</li>
<li>Nested destructuring handling</li>
</ol>
<h2 id="architecture">Architecture</h2>
<h3 id="compilation-pipeline">Compilation Pipeline</h3>
<p>In <code>ParserManager.cs</code>, the destructuring phases are:</p>
<pre><code class="language-csharp">// Phase 1: Resolve property references in destructuring (line 136-137)
if (upTo &gt;= AnalysisPhase.DestructuringLowering)
    ast = new DestructuringVisitor().Visit(ast);

// Phase 2: Lower destructuring to variable declarations (line 139-143)  
if (upTo &gt;= AnalysisPhase.DestructuringLowering)
{
    var rewriter = new DestructuringLoweringRewriter();
    var result = rewriter.Rewrite(ast);
    ast = result.Node;
}
</code></pre>
<p><strong>Note:</strong> <code>DestructuringPatternFlattenerVisitor</code> is now disabled (lines 84-87) as its functionality is replaced by <code>DestructuringLoweringRewriter</code>.</p>
<h3 id="destructuringloweringrewriter">DestructuringLoweringRewriter</h3>
<p>The rewriter performs the following transformations:</p>
<h4 id="1-constraint-collection">1. Constraint Collection</h4>
<p>For each property binding with a constraint, the rewriter:
- Collects the constraint expression
- Rewrites variable references to use parameter.property access
- Combines all constraints into a single parameter-level constraint</p>
<p><strong>Example:</strong></p>
<pre><code class="language-fifth">f(p: Person { age: Age | age &gt; 18, name: Name | name != &quot;&quot; })
</code></pre>
<p>Becomes:</p>
<pre><code class="language-csharp">ParamDef with ParameterConstraint: p.Age &gt; 18 &amp;&amp; p.Name != &quot;&quot;
</code></pre>
<h4 id="2-variable-declaration-generation">2. Variable Declaration Generation</h4>
<p>For each property binding, generates a VarDeclStatement at the start of the function body:</p>
<p><strong>Example:</strong></p>
<pre><code class="language-fifth">f(p: Person { age: Age, name: Name }): int { ... }
</code></pre>
<p>Generates:</p>
<pre><code class="language-csharp">public static int f(Person p)
{
    int age = p.Age;
    string name = p.Name;
    // ... original function body
}
</code></pre>
<h4 id="3-nested-destructuring">3. Nested Destructuring</h4>
<p>Handles nested destructuring by chaining property access:</p>
<p><strong>Example:</strong></p>
<pre><code class="language-fifth">f(p: Person { address: Address { city: City } })
</code></pre>
<p>Generates:</p>
<pre><code class="language-csharp">Address address = p.Address;
string city = address.City;
</code></pre>
<h2 id="key-benefits">Key Benefits</h2>
<h3 id="1-statement-hoisting">1. Statement Hoisting</h3>
<p>The rewriter uses <code>RewriteResult.Prologue</code> to hoist generated statements, which are automatically spliced by <code>VisitBlockStatement</code>:</p>
<pre><code class="language-csharp">public override RewriteResult VisitFunctionDef(FunctionDef ctx)
{
    var destructuringStatements = new List&lt;Statement&gt;();
    // Generate variable declarations...

    // Combine with original body
    bodyStatements.AddRange(destructuringStatements);
    bodyStatements.AddRange(originalBodyStatements);

    return new RewriteResult(updatedFunction, []);
}
</code></pre>
<h3 id="2-no-backend-special-cases">2. No Backend Special Cases</h3>
<p>The backend (<code>LoweredAstToRoslynTranslator</code>) only sees standard AST nodes:
- <code>VarDeclStatement</code> - for introduced variables
- <code>MemberAccessExp</code> - for property reads
- <code>GuardStatement</code> / <code>IfElseStatement</code> - for constraints (via guard validation)
- <code>VarRefExp</code> - for variable references</p>
<p>No special handling of destructuring forms is needed.</p>
<h3 id="3-clean-separation-of-concerns">3. Clean Separation of Concerns</h3>
<ul>
<li><strong>Resolution</strong> (DestructuringVisitor) - Links property bindings to property definitions</li>
<li><strong>Lowering</strong> (DestructuringLoweringRewriter) - Transforms high-level destructuring into low-level operations</li>
<li><strong>Guard Validation</strong> (GuardCompletenessValidator) - Validates parameter constraints</li>
</ul>
<h2 id="implementation-details">Implementation Details</h2>
<h3 id="property-type-resolution">Property Type Resolution</h3>
<p>The rewriter uses <code>ReferencedProperty.TypeName</code> to determine variable types:</p>
<pre><code class="language-csharp">var typeName = binding.ReferencedProperty?.TypeName ?? TypeName.From(&quot;object&quot;);
var varDecl = new VariableDecl { TypeName = typeName, ... };
</code></pre>
<p>This ensures variables have the correct types in generated code.</p>
<h3 id="constraint-rewriting">Constraint Rewriting</h3>
<p>Constraints are rewritten to reference <code>param.property</code> instead of the introduced variable:</p>
<p><strong>Before:</strong></p>
<pre><code class="language-csharp">// Constraint: age &gt; 18 (references the introduced variable 'age')
PropertyBindingDef { 
    IntroducedVariable = &quot;age&quot;,
    Constraint = BinaryExp { LHS = VarRefExp(&quot;age&quot;), ... }
}
</code></pre>
<p><strong>After:</strong></p>
<pre><code class="language-csharp">// Constraint: p.Age &gt; 18 (references parameter property)
ParamDef {
    ParameterConstraint = BinaryExp { 
        LHS = MemberAccessExp { 
            LHS = VarRefExp(&quot;p&quot;), 
            RHS = VarRefExp(&quot;Age&quot;) 
        }, 
        ... 
    }
}
</code></pre>
<h3 id="fresh-name-generation">Fresh Name Generation</h3>
<p>The rewriter includes a name generator for temporary variables:</p>
<pre><code class="language-csharp">private int _tmpCounter = 0;
private string FreshTempName(string prefix = &quot;tmp&quot;) =&gt; $&quot;__{prefix}{_tmpCounter++}&quot;;
</code></pre>
<p>Currently used for potential future optimizations (e.g., hoisting once-per-parameter temps).</p>
<h2 id="testing">Testing</h2>
<h3 id="ast-tests">AST Tests</h3>
<p>All 343 AST tests pass, validating:
- Parser correctness
- AST transformation correctness<br />
- Visitor/rewriter behavior</p>
<h3 id="runtime-integration-tests">Runtime Integration Tests</h3>
<p>160 out of 199 runtime integration tests pass. Failures are primarily due to:
- External dependencies (e.g., <code>print</code> function resolution)
- Knowledge graph operations (unrelated)
- Platform/execution issues</p>
<p>Destructuring-specific compilation succeeds, generating correct C# code with proper types.</p>
<h2 id="migration-guide">Migration Guide</h2>
<p>For future similar migrations:</p>
<ol>
<li><strong>Identify the core transformation</strong> - What is the high-level construct being lowered?</li>
<li><strong>Choose the right pattern</strong>:</li>
<li>Use <code>DefaultRecursiveDescentVisitor</code> for simple, type-preserving transformations</li>
<li>Use <code>DefaultAstRewriter</code> for lowering that needs statement hoisting</li>
<li><strong>Separate concerns</strong>:</li>
<li>Keep resolution/linking in visitors</li>
<li>Put lowering in rewriters</li>
<li><strong>Test incrementally</strong>:</li>
<li>Start with AST tests</li>
<li>Verify generated code structure</li>
<li>Run runtime tests last</li>
</ol>
<h2 id="future-work">Future Work</h2>
<p>Potential improvements:</p>
<ol>
<li>
<p><strong>Single-evaluation temps</strong> - When source expression has side effects, hoist a temp:
   <code>csharp
   var p_tmp = &lt;expression&gt;;
   var age = p_tmp.Age;
   var name = p_tmp.Name;</code></p>
</li>
<li>
<p><strong>Assignment destructuring</strong> - Extend to support destructuring in variable declarations and assignments:
   <code>fifth
   { age: myAge, name: myName } = person;</code></p>
</li>
<li>
<p><strong>Pattern matching</strong> - Integrate with future pattern matching features</p>
</li>
<li>
<p><strong>Optimizations</strong> - Eliminate intermediate variables when safe to do so</p>
</li>
</ol>
<h2 id="references">References</h2>
<ul>
<li>Rewriter base: <code>src/ast-generated/rewriter.generated.cs</code></li>
<li>Current implementation: <code>src/compiler/LanguageTransformations/DestructuringLoweringRewriter.cs</code></li>
<li>Property resolution: <code>src/compiler/LanguageTransformations/DestructuringVisitor.cs</code></li>
<li>Pipeline: <code>src/compiler/ParserManager.cs</code></li>
<li>Roslyn backend: <code>src/compiler/LoweredToRoslyn/LoweredAstToRoslynTranslator.cs</code></li>
</ul>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../debugging/" class="btn btn-neutral float-left" title="Debugging Workflows"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../generics-implementation-summary/" class="btn btn-neutral float-right" title="Generic Type Support Implementation Summary">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../debugging/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../generics-implementation-summary/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../..";</script>
    <script src="../../../js/theme_extra.js"></script>
    <script src="../../../js/theme.js"></script>
      <script src="../../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
